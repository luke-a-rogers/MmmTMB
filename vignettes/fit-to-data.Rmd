---
title: "fit-to-data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{fit-to-data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 5, 
  fig.fullwidth = TRUE
)
```

```{r setup}
library(mmmTMB)
```

# Wrangle Tag Data

## Load Tag Data
```{r load-tag-data}
# Use observational data
# TODO: Switch to simulated data
load("~/github/sablefishData/data/sable_released.rda")
load("~/github/sablefishData/data/sable_recovered.rda")

```

## Create mmmTags object
```{r create-mmmtags}
# Prepare arguments
cols <- list(
  release_date = "Release_Date",
  release_area = "Release_Region",
  recover_date = "Recovery_Date",
  recover_area = "Recovery_Region",
  id = "Tag_ID"
)
# Call mmmTags()
tags <- mmmTags(x = sable_released,
                y = sable_recovered,
                cols = cols,
                step = "year",
                limits = c("1979-01-01", "2018-12-31"))

```

## Load Rates Data
```{r load-rates-data}
# Use observational data
# TODO: Switch to simulated data
load("~/github/sablefishData/data/sable_capture_rate_region.rda")
load("~/github/sablefishData/data/sable_report_ratio.rda")

```

## Create mmmRates Objects
```{r create-mmmrates}
# Prepare fishing mortality rates
x <- sable_capture_rate_region
cols <- list(date = "Year", area = "Region", rate = "Capture_Inst_Year")
reps <- 1 # Update to 12 for monthly fit
lims <- c(1979, 2018)
mF <- mmmRates(x, cols, reps, lims, inst = TRUE)

# Prepare tag reporting rates
x <- dplyr::distinct(sable_report_ratio, Year, Region, Report_Ratio)
cols <- list(date = "Year", area = "Region", rate = "Report_Ratio")
reps <- 1 # Update to 12 for monthly fit
lims <- c(1979, 2018)
mL <- mmmRates(x, cols, reps, lims, inst = FALSE)

```

## Create mmmWeights Object
```{r create-mmmweights}
# Prepare monthly weighting of annual fishing rate by tag recoveries
# TODO: Update for monthly fit

# mW <- mmmWeights(tags, step = "month", nrows = 12L)

```

## Create Movement Index Matrix
```{r create-mmmindex}
# Three area neighbours
mI <- mmmIndex(3, pattern = 0)


```

## Define Remaining Data
```{r create-remaining-data}
# Remaining data
sM <- 0.1 # Divide by 12 for monthly
sH <- 0.02 # Divide by 12 for monthly
sC <- 0.1

```


## Populate Data List
```{r create-data-list}
d <- list(
  tags = tags,
  mI = mI,
  mL = mL,
  # mW = mW,
  mF = mF,
  sM = sM,
  sH = sH,
  sC = sC
)

```

## Populate Parameter List
```{r create-parameter-list}
p <- NULL


```

## Population Settings List
```{r create-settings-list}
s <- mmmSet(
  error_family = 0, 
  span_liberty = c(1, 40),
  nlminb_loops = 5,
  newton_steps = 5,
  openmp_cores = 6)

s <- mmmSet(
  error_family = 1,
  span_liberty = c(1, 40),
  nlminb_loops = 5,
  newton_steps = 5,
  openmp_cores = 6)

```


## Fit To Data
```{r fit-to-data}
# Fit
fit <- mmmFit(
  data = d,
  parameters = p,
  random = NULL,
  map = NULL,
  settings = s,
  control = mmmControl(trace = 5)
)

```
